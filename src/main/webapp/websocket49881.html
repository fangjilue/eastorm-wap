<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Insert title here</title>
    <script type="text/javascript" src="js/jquery-1.7.1.min.js"></script>
    <script type="text/javascript" src="js/json2.js"></script>
</head>
<body>

<form onsubmit="return false;">
    <input type="button" value="1、建立连接" onclick="createConn()"/>
    设置当前用户id:<input type="text" name="curUserId" id="curUserId"/>
    设置平台：<select id="platform" name="platform" >
    <option value="1" selected>h5</option>
    <option value="2">支付宝服务窗</option>
    <option value="3">微信小程序</option>
</select>
    <input type="button" value="2、登录" onclick="send('0','请求登录',1);"/>
    <input type="button" value="4、下线" onclick="send('0','下线',6)"/>
    <br/><br/>
    发消息<input type="text" name="message" id="message"/>
    给用户id<input type="text" name="toUserId"/>
    <input type="button" value="3、发送webSocket请求消息" onclick="send(this.form.toUserId.value,this.form.message.value,2)"/>

    <hr color="blue"/>
    <h3>服务端返回的应答消息</h3>
    <textarea id="responseText" style="width:500px;height:300px"></textarea>
</form>


<script type="text/javascript">
   /**
   heartbeat(0,"心跳"),login(1,"登录"),text(2,"文本"),picture(3,"图片"),
   video(4,"视频"),location(5,"地理位置"),close(6,"关闭"),ack(7,"确认")
   **/

   var socket;
   //是否网络在线，0-下线，1-连接建立中，2-连接在线
   var online=0;
   //pong最后时间
   var pongLastTime=0;
   //是否主动下线
   var isLoginOut=false;
   var addr="ws://192.168.21.105:49881/websocket";


   function createConn(){
        reCount=0;
        connect();
   }

    //连接socket，只有
   function connect(){
        if(online!=0){
            return;
        }


       online=1;
       if(!window.WebSocket){
            window.WebSocket = window.MozWebSocket;
       }

       if(window.WebSocket){
            socket = new WebSocket(addr);

            socket.onopen = function(event){
                //已连接
                appendTxt("打开WebSocket服务正常，浏览器支持WebSocket！");

                //初始化
                online=2;
                pongLastTime=0;
                isLoginOut=false;
                heartBeat();
            }

            socket.onmessage = function(event){
                //接收到消息
                if(event.data=='pong'){
                    pongLastTime=new Date().getTime();
                }
                if(event.data=='pong'||event.data.indexOf('ack')>=0){
                    console.log(event.data);
                    return;
                }

                var resp=JSON.parse(event.data);

                appendTxt(resp.sender.userName+" 发送 "+ resp.content+"\t"+resp.sendTime+"\n");

                //ack
                var wsMsg={};
                wsMsg.content="ack";
                wsMsg.type=7;
                wsMsg.platform=document.getElementById('platform').value;
                wsMsg.msgId=resp.msgId;

                var txt=JSON.stringify(wsMsg);
                socket.send(txt);
            };

            socket.onclose = function(event){
                //关闭
                online=0;
                appendTxt('WebSocket关闭！');

                //判断如果不是主动关闭则重试
                if(!isLoginOut&&reCount==0){
                    reConnect();
                }
            }
       }else{
            online=0;
            alert("抱歉，您的浏览器不支持WebSocket协议！");
       }
   }

   function send(toUserId,message,type){
        if(!socket){return;}

        if(socket.readyState == WebSocket.OPEN && online==2){
            var curUserId = document.getElementById('curUserId').value;

            var wsMsg={};
            wsMsg.msgId=guid();
            wsMsg.content=message;
            wsMsg.type=type;
            wsMsg.platform=document.getElementById('platform').value;

            wsMsg.sender={};
            wsMsg.sender.userId=curUserId;
            wsMsg.sender.userName=curUserId;

            wsMsg.receiver={};
            wsMsg.receiver.userId=toUserId;
            wsMsg.receiver.userName=toUserId;

            var txt=JSON.stringify(wsMsg);
            socket.send(txt);

            appendTxt(wsMsg.sender.userName+" 发送 "+ wsMsg.content+"\t");

            if(type==6){
                isLoginOut=true;
            }else if(type==1){
                isLoginOut=false;
            }
        }else{
            alert('连接建立中，请稍等');
        }
   }

   //心跳处理

   var checkPonginterval =null,heartInterval =null;
   function heartBeat(){
        //检测心跳，如果网线断了，心跳不一定能及时检测到socket.readyState的变化
       heartInterval =  setInterval(function(){
                if(socket.readyState == WebSocket.OPEN){

                    var wsMsg={};
                    wsMsg.type=0;//心跳
                    wsMsg.platform=document.getElementById('platform').value;
                    wsMsg.sender={};
                    wsMsg.msgId=guid();

                    var curUserId = document.getElementById('curUserId').value;
                    wsMsg.sender.userId=curUserId;

                    var txt=JSON.stringify(wsMsg);
                    socket.send(txt);
                }else{
                    clearInterval(heartInterval);
                }
        }, 1000);

        //检测服务器回应
        checkPonginterval =  setInterval(function(){
                if(socket.readyState == WebSocket.OPEN){

                    if(pongLastTime>0&&new Date().getTime()-pongLastTime>3*1000){
                        online=0;
                        //3m没收到pong，停止心跳检测
                        appendTxt("检测到WebSocket断开大于3秒，重试连接");
                        reConnect();
                    }else{
                        console.log('check pong time:'+pongLastTime);
                    }
                }else{
                    pongLastTime=0;
                    clearInterval(checkPonginterval);
                }
        }, 1000);
   }

   function appendTxt(txt){
        var ta = document.getElementById('responseText');
        ta.value = ta.value + txt+"\n";
   }

   //重连接，如果是异常关闭，则开启重连接前先关闭心跳和pong检测
   var reCount=0;
   function reConnect(){
        if(heartInterval!=null){
            clearInterval(heartInterval);
        }
        if(checkPonginterval!=null){
            clearInterval(checkPonginterval);
        }

        if(reCount==0){
             var reConnInterval =  setInterval(function(){
                    if(socket.readyState == WebSocket.OPEN && online==2){
                        send('0','请求登录',1);
                        clearInterval(reConnInterval);
                        return;
                    }

                   if(reCount>=30){
                       clearInterval(reConnInterval);
                   }else{
                       reCount++;
                       connect();
                       appendTxt('重新连接第'+reCount+'次');
                   }
            }, 1000);
        }
   }


   function S4() {
        return (((1+Math.random())*0x10000)|0).toString(16).substring(1);
    }
    function guid() {
        return (S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4());
    }
</script>
</body>
</html>